---
title: "Assignment 3"
author: "Walter Verwer & Bas Machielsen"
date: "1/17/2021"
output:
  pdf_document:
    includes:
      in_header: "preamble.tex"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Register an inline hook (set rounding to 3 digitis):
knitr::knit_hooks$set(inline = function(x) {
  x <- sprintf("%1.3f", x)
  paste(x, collapse = ", ")
})

library(stargazer)
library(tidyverse)
library(haven)
library(knitr)

# Import Stata dataset
bonus <- haven::read_dta("./data/bonus.dta")
```

## Question 1

### 1.1

```{r warning=FALSE, message=FALSE}
data <- tribble(
    ~ color, ~ no_treated, ~ no_contr, ~ avg_treated, ~avg_control,
    "purple", 100, 100, 9, 7,
    "blue", 75, 25, 13, 8,
    "green", 25, 75, 10, 9
)

data %>%
    group_by(color) %>%
    summarize(treatment_effect = avg_treated - avg_control)

```

### 1.2

The ATE is defined as $\mathbb{E}[\delta] = \mathbb{E}[Y^*_1] - \mathbb{E}[Y^*_0]$ which are the expectations of the potential outcomes. In general, these two variables are not observed. Under the _random assignment_ assumption, we assume that $\mathbb{E}[Y_1^*] = \mathbb{E}[Y_1^* | D = 1]$ and $\mathbb{E}[Y_0^*] = \mathbb{E}[Y_0^* | D = 0]$, which can be estimated by their sample by their sample equivalents:

```{r warning=FALSE, message=FALSE}
data %>%
    summarize(
        e_y1_d_is_1 = (9*100 + 13 * 75 + 10 * 25) / sum(no_treated),
        e_y0_d_is_0 = (7 * 100 + 8 * 25 + 9 * 75) / sum(no_contr)) %>%
    summarize(e_y1_d_is_1 - e_y0_d_is_0)

```

### 1.3

The ATT is defined as $\mathbb{E}[\delta | D = 1] = \mathbb{E}[Y^1 | D =1] - \mathbb{E}[Y^0 | D=1]$. The first term is readily observable. The second term is estimated by us as $\hat{\mathbb{E}}[Y^0 | D =1] = \mathbb{E}[Y^0 | D = 0]$. Hence:

```{r warning=FALSE, message=FALSE}
data_ate <- data %>%
    mutate(n = no_treated + no_contr) %>%
    summarize(e_y1_d_is_1 = (9 * 100 + 13 * 75 + 10 * 25) / sum(no_treated),
              e_y0_d_is_0 = (7 * 100 + 8 * 25 + 9 * 75) / sum(no_contr))

data_ate 

data_ate %>%
    summarize(att = e_y1_d_is_1 - e_y0_d_is_0)
```

So the $ATE = ATT$ (because of randomization). 

# Question 2

### 2.1

__Compute the fraction of students in all three groups (control, low-reward and high-reward) that complete all first-year courses before the start of the second academic year. Show within a table that background characteristics are balanced over the treatment groups.__


```{r message=FALSE}
bonus_clean <- bonus %>%
    pivot_longer(cols = c(bonus0, bonus500, bonus1500), 
                 names_to = "kind_treatment",
                 values_to = "treatment") %>%
    filter(treatment == 1) 

bonus_clean %>%
    group_by(kind_treatment) %>%
    summarize(fraction_pass = sum(pass)/n()) %>%
    kable(caption = "Fraction passed per treatment")

```

```{r message = FALSE}

#Drop the outcome variables
bonus_clean %>%
    group_by(kind_treatment) %>%
    select(-c(pass, stp2001, stp2004, dropout)) %>%
    summarize(across(p0:math, 
                     list(mean = ~ mean(., na.rm = TRUE), 
                          sd = ~ sd(., na.rm = TRUE)))) %>%
    pivot_longer(-kind_treatment, names_to = "variable") %>%
    separate(variable, into = c("var", "statistic"), sep = "_") %>%
    pivot_wider(names_from = c(kind_treatment, statistic)) %>%
    kable(caption = "Means and SDs according to treatment", digits = 3)

```

### 2.2

__Use the linear probability model to regress the dummy variable for completing all courses on the assignment of the three treatment groups. Interpret the treatment effects. Next include as additional regressors father's education, high-school math score and the subjective assessment about the pass probability.__

```{r pass on groups, results='asis'}
# First attach data set for easy access:
attach(bonus)

# We need to regress pass on the treatment group assignment. This is
# a simple linear probability model. Model is denoted by prob_1. 
# Note, we need to ommit bonus0, cause of a dummy variable trap.
prob_1 <- lm(pass ~ bonus500 + bonus1500, data=bonus)

# Same as before, but now with some extra variables
prob_2 <- lm(pass ~ bonus500 + bonus1500 + fyeduc + math + p0, data=bonus)

# for q2.3:
prob_3 <- lm(pass ~ bonus500 + bonus1500 + fyeduc + math + p0 + job + effort, data=bonus)

# I think we should take the largest model. BAS???:
prob_4 <- lm(pass ~ bonus500 + bonus1500 + fyeduc + math + p0 + job + effort + dropout + stp2001 + stp2004, data=bonus)

# Create table:
stargazer(prob_1, prob_2, prob_3, prob_4, header=FALSE, style='aer')
```

### 2.3

__Next also include as regressors in your model whether a student has a job and the amount of study effort. Comment on this approach. Do you consider this an improvement over (ii)?__



### 2.4

__Use your preferred model specifcation to estimate the effects of the financial incentives on some other outcomes: dropping out and credit points collected (in the first year and after three years).__








