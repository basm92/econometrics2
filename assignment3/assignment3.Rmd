---
title: "Assignment 3"
author: "Walter Verwer & Bas Machielsen"
date: "1/17/2021"
output:
  pdf_document:
    includes:
      in_header: "preamble.tex"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(stargazer)
library(tidyverse)
library(haven)
library(knitr)

# Import Stata dataset
bonus <- haven::read_dta("./data/bonus.dta")
```

## Question 1

### 1.1

```{r warning=FALSE, message=FALSE}
data <- tribble(
    ~ color, ~ no_treated, ~ no_contr, ~ avg_treated, ~avg_control,
    "purple", 100, 100, 9, 7,
    "blue", 75, 25, 13, 8,
    "green", 25, 75, 10, 9
)

data %>%
    group_by(color) %>%
    summarize(treatment_effect = avg_treated - avg_control)

```

### 1.2

The ATE is defined as $\mathbb{E}[\delta] = \mathbb{E}[Y^*_1] - \mathbb{E}[Y^*_0]$ which are the expectations of the potential outcomes. In general, these two variables are not observed. Under the _random assignment_ assumption, we assume that $\mathbb{E}[Y_1^*] = \mathbb{E}[Y_1^* | D = 1]$ and $\mathbb{E}[Y_0^*] = \mathbb{E}[Y_0^* | D = 0]$, which can be estimated by their sample by their sample equivalents:

```{r warning=FALSE, message=FALSE}
data %>%
    summarize(
        e_y1_d_is_1 = (9*100 + 13 * 75 + 10 * 25) / sum(no_treated),
        e_y0_d_is_0 = (7 * 100 + 8 * 25 + 9 * 75) / sum(no_contr)) %>%
    summarize(e_y1_d_is_1 - e_y0_d_is_0)

```

### 1.3

The ATT is defined as $\mathbb{E}[\delta | D = 1] = \mathbb{E}[Y^1 | D =1] - \mathbb{E}[Y^0 | D=1]$. The first term is readily observable. The second term is estimated by us as $\hat{\mathbb{E}}[Y^0 | D =1] = \mathbb{E}[Y^0 | D = 0]$. Hence:

```{r warning=FALSE, message=FALSE}
data_ate <- data %>%
    mutate(n = no_treated + no_contr) %>%
    summarize(e_y1_d_is_1 = (9 * 100 + 13 * 75 + 10 * 25) / sum(no_treated),
              e_y0_d_is_0 = (7 * 100 + 8 * 25 + 9 * 75) / sum(no_contr))

data_ate 

data_ate %>%
    summarize(att = e_y1_d_is_1 - e_y0_d_is_0)
```

So the $ATE = ATT$ (because of randomization). 

# Question 2

### 2.1

Compute the fraction of students in all three groups (control, low-reward and high-reward) that complete all first-year courses before the start of the second academic year. Show within a table that background characteristics are balanced over the treatment groups.


```{r message=FALSE}
bonus_clean <- bonus %>%
    pivot_longer(cols = c(bonus0, bonus500, bonus1500), 
                 names_to = "kind_treatment",
                 values_to = "treatment") %>%
    filter(treatment == 1) 

bonus_clean %>%
    group_by(kind_treatment) %>%
    summarize(fraction_pass = sum(pass)/n()) %>%
    kable(caption = "Fraction passed per treatment")

```

```{r message = FALSE}

#Drop the outcome variables
bonus_clean %>%
    group_by(kind_treatment) %>%
    select(-c(pass, stp2001, stp2004, dropout)) %>%
    summarize(across(p0:math, 
                     list(mean = ~ mean(., na.rm = TRUE), 
                          sd = ~ sd(., na.rm = TRUE)))) %>%
    pivot_longer(-kind_treatment, names_to = "variable") %>%
    separate(variable, into = c("var", "statistic"), sep = "_") %>%
    pivot_wider(names_from = c(kind_treatment, statistic)) %>%
    kable(caption = "Means and SDs according to treatment")

```

